---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;
const filtered = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

{filtered.length > 2 && (
  <aside class="hidden xl:block sticky top-20 self-start w-56 shrink-0">
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">目錄</p>
      <nav>
        <ul class="space-y-1">
          {filtered.map((heading) => (
            <li class:list={['leading-snug', heading.depth === 3 && 'pl-3']}>
              <a
                href={`#${heading.slug}`}
                class:list={[
                  'toc-link block text-xs py-0.5 text-gray-500 hover:text-indigo-600 transition-colors',
                  heading.depth === 2 && 'font-medium text-gray-600',
                ]}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </div>
  </aside>
)}

<script>
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  const headingEls = document.querySelectorAll<HTMLElement>('h2[id], h3[id]');

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          tocLinks.forEach((link) => link.classList.remove('active'));
          const active = document.querySelector<HTMLElement>(`.toc-link[href="#${entry.target.id}"]`);
          active?.classList.add('active');
        }
      });
    },
    { rootMargin: '-80px 0px -60% 0px' }
  );

  headingEls.forEach((el) => observer.observe(el));
</script>
