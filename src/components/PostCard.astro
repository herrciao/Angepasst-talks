---
import type { CollectionEntry } from 'astro:content';
import { CATEGORIES, CATEGORY_COLORS, getCategoryColor, type ColorKey } from '@/config';

interface Props {
  post: CollectionEntry<'posts'>;
  compact?: boolean;
}

const { post, compact = false } = Astro.props;
const { title, description, date, category, subcategory, tags } = post.data;

const colorKey = getCategoryColor(category) as ColorKey;
const colors = CATEGORY_COLORS[colorKey] ?? CATEGORY_COLORS.gray;

const catConfig = CATEGORIES.find((c) => c.id === category);
const subCatConfig = catConfig?.children?.find((c) => c.id === subcategory);
const displayLabel = subCatConfig?.label ?? catConfig?.label ?? category;
const displayHref = subCatConfig?.href ?? catConfig?.href ?? `/category/${category}`;

const formattedDate = new Intl.DateTimeFormat('zh-TW', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(date);
---

<article class:list={['card group', compact ? 'p-4' : 'p-5']}>
  <div class="flex items-start justify-between gap-3 mb-2">
    <a
      href={displayHref}
      class:list={['inline-block text-xs font-medium px-2 py-0.5 rounded-full border', colors.bg, colors.text, colors.border]}
    >
      {displayLabel}
    </a>
    <time datetime={date.toISOString()} class="text-xs text-gray-400 shrink-0 pt-0.5">
      {formattedDate}
    </time>
  </div>

  <h2 class:list={['font-bold text-gray-900 group-hover:text-indigo-600 transition-colors leading-snug', compact ? 'text-base' : 'text-lg']}>
    <a href={`/posts/${post.slug}`}>{title}</a>
  </h2>

  {!compact && description && (
    <p class="mt-2 text-sm text-gray-500 leading-relaxed line-clamp-2">{description}</p>
  )}

  {!compact && tags.length > 0 && (
    <div class="mt-3 flex flex-wrap gap-1.5">
      {tags.slice(0, 4).map((tag) => (
        <a
          href={`/tag/${tag}`}
          class="text-xs text-gray-500 bg-gray-100 hover:bg-indigo-50 hover:text-indigo-600 px-2 py-0.5 rounded transition-colors"
        >
          #{tag}
        </a>
      ))}
    </div>
  )}
</article>
