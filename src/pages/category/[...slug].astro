---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import Pagination from '@/components/Pagination.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';
import { CATEGORIES, SITE } from '@/config';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);
  const paths: { params: { slug: string }; props: object }[] = [];

  for (const cat of CATEGORIES) {
    const catPosts = allPosts.filter((p) => p.data.category === cat.id);
    const sorted = catPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
    const totalPages = Math.max(1, Math.ceil(sorted.length / SITE.postsPerPage));

    for (let page = 1; page <= totalPages; page++) {
      paths.push({
        params: { slug: page === 1 ? cat.id : `${cat.id}/page/${page}` },
        props: { category: cat.id, subcategory: null, posts: sorted, currentPage: page, totalPages },
      });
    }

    if (cat.children) {
      for (const sub of cat.children) {
        const subPosts = allPosts.filter(
          (p) => p.data.category === cat.id && p.data.subcategory === sub.id
        ).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
        const subTotal = Math.max(1, Math.ceil(subPosts.length / SITE.postsPerPage));

        for (let page = 1; page <= subTotal; page++) {
          paths.push({
            params: { slug: page === 1 ? `${cat.id}/${sub.id}` : `${cat.id}/${sub.id}/page/${page}` },
            props: { category: cat.id, subcategory: sub.id, posts: subPosts, currentPage: page, totalPages: subTotal },
          });
        }
      }
    }
  }

  return paths;
}

const { category, subcategory, posts, currentPage, totalPages } = Astro.props;

const catConfig = CATEGORIES.find((c) => c.id === category);
const subCatConfig = catConfig?.children?.find((c) => c.id === subcategory);
const displayName = subCatConfig?.label ?? catConfig?.label ?? category;
const baseUrl = subcategory ? `/category/${category}/${subcategory}` : `/category/${category}`;

const pagePosts = posts.slice((currentPage - 1) * SITE.postsPerPage, currentPage * SITE.postsPerPage);

const crumbs = [
  ...(catConfig && subcategory ? [{ label: catConfig.label, href: catConfig.href }] : []),
  { label: displayName },
];
---

<BaseLayout title={displayName}>
  <Breadcrumb crumbs={crumbs} />

  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">{displayName}</h1>
      <p class="text-sm text-gray-500 mt-1">{posts.length} 篇文章</p>
    </div>
  </div>

  <div class="space-y-4">
    {pagePosts.map((post) => <PostCard post={post} />)}
    {pagePosts.length === 0 && (
      <div class="text-center py-16 text-gray-400">
        <p>這個分類還沒有文章</p>
      </div>
    )}
  </div>

  <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={baseUrl} />
</BaseLayout>
